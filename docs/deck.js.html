

<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>JSDoc: deck.js</title>

    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="./build/entry.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="https://fonts.googleapis.com/css?family=Muli:100,400,700|Oswald:300|Inconsolata,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
    <link type="text/css" rel="stylesheet" href="styles/app.min.css">
    <link type="text/css" rel="stylesheet" href="styles/iframe.css">
</head>

<body>
    <div id="stickyNavbarOverlay"></div>
    <div class="top-navbar">
        <div class="container">
            <nav class="navbar" role="navigation" aria-label="main navigation">
                <div class="navbar-brand">
                    
                     
                        <h1 class="navbar-item">Simple Flashcards Cloud Functions Dokumentace</h1>
                    
                    <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                    </a>
                </div>
                 
                <div class="navbar-menu">
                    <div class="navbar-end">
                    
                        <div class="navbar-item">
                            <a href="https://github.com/Morcinus/SimpleFlashCards" target="_blank">
                                Github
                            </a>
                        </div>
                    
                        <div class="navbar-item">
                            <a href="https://simpleflashcards-4aea0.firebaseapp.com" target="_blank">
                                Aplikace
                            </a>
                        </div>
                    
                    </div>
                </div>
                
            </nav>
        </div>
    </div>
    <div class="container">
        <div class="columns">
            <div class="column is-3" id="sidebarNav">
                <div class="sidebar">
                    <nav>
                        <h2><a href="index.html">Home</a></h2><div class="category"></div><div class="category"><h2>Funkce</h2><h3>Modules</h3><ul><li><a href="module-collection.html">collection</a></li><li><a href="module-collectionCards.html">collectionCards</a></li><li><a href="module-deck.html">deck</a></li><li><a href="module-deckCards.html">deckCards</a></li><li><a href="module-user.html">user</a></li></ul></div>
                    </nav>
                </div>
            </div>
            <div class="column is-9-desktop">
                <div class="content" id="main-content-wrapper">
                    <header class="page-title">
                        <p>Source</p>
                        <h1>deck.js</h1>
                    </header>
                    
                    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { db, admin } = require("../util/admin");
const config = require("../util/firebaseConfig");

const { Storage } = require("@google-cloud/storage");

/**
 * @module deck
 * @category Funkce
 * @description Zde jsou funkce, které se starají o data balíčků.
 */

//#region Deck Editing
/**
 * @function validateDeckData
 * @description Ověří, zda-li obsahuje název balíčku pouze povolené znaky a zda-li je v balíčku alespoň 1 karta.
 * @param {string} deckName - Název balíčku
 * @param {Array&lt;Object>} cardArray - Pole karet
 * @returns {Array&lt;String>} Vrací pole error kódů. Pokud ověření proběhlo bez problému, vrací prázdné pole.
 */
const validateDeckData = (deckName, cardArray) => {
  let errors = [];

  // Ověření názvu balíčku
  if (deckName !== "") {
    let deckNameRegex = /^[a-zA-Z0-9 ]+$/;
    if (!deckName.match(deckNameRegex)) {
      errors.push("createDeck/invalid-deck-name");
    }
  } else {
    errors.push("createDeck/empty-deck-name");
  }

  // Ověření, zda je v balíčku alespoň 1 karta
  if (cardArray.length &lt;= 0) {
    errors.push("createDeck/empty-deck");
  }

  return errors;
};

/**
 * @function createDeck
 * @description Vytvoří v soubor s daty balíčku v databázi.
 * @param {Object} req - Požadavek, který přišel na server.
 * @param {string} req.user.uid - ID uživatele
 * @param {string} req.body.deckName - Název vytvářeného balíčku
 * @param {string} req.body.deckDescription - Popisek vytvářeného balíčku
 * @param {Array&lt;Object>} req.body.deckCards - Pole s kartami vytvářeného balíčku
 * @param {boolean} req.body.private - Informace o tom, zda je balíček veřejný či soukromý.
 * @param {Object} res - Odpověď na požadavek, který přišel na server.
 * @returns {string} deckId - ID vytvořeného balíčku.
 * @async
 */
exports.createDeck = (req, res) => {
  // Ověření dat balíčku
  const errorCodes = validateDeckData(req.body.deckName, req.body.deckCards);
  if (errorCodes.length > 0) {
    return res.status(400).json({ errorCodes: errorCodes });
  }

  // Vygenerování ID pro každou kartu v balíčku
  let cardArray = [];
  req.body.deckCards.forEach(card => {
    let newCard = card;
    newCard.cardId = newId();
    cardArray.push(newCard);
  });

  // Vytvoření deckData
  const deckData = {
    creatorId: req.user.uid,
    deckName: req.body.deckName,
    deckDescription: req.body.deckDescription ? req.body.deckDescription : null,
    cardArray: cardArray,
    private: req.body.private
  };

  // Přídání balíčku do databáze
  db.collection("decks")
    .add(deckData)
    .then(docReference => {
      // Zapsání balíčku do seznamu balíčků vytvořených daným uživatelem
      db.collection("users")
        .doc(req.user.uid)
        .update({
          createdDecks: admin.firestore.FieldValue.arrayUnion(docReference.id)
        });

      return docReference.id;
    })
    .then(deckId => {
      res.status(200).json({ deckId: deckId });
    })
    .catch(err => {
      return res.status(500).json({ errorCode: err.code });
    });
};

/**
 * @function updateDeck
 * @description Upraví v soubor s daty balíčku v databázi.
 * @param {Object} req - Požadavek, který přišel na server.
 * @param {string} req.user.uid - ID uživatele
 * @param {string} req.params.deckId - ID upravovaného balíčku
 * @param {string} req.body.deckName - Název upravovaného balíčku
 * @param {string} req.body.deckDescription - Popisek upravovaného balíčku
 * @param {Array&lt;Object>} req.body.deckCards - Pole s kartami upravovaného balíčku
 * @param {boolean} req.body.private - Informace o tom, zda je upravovaný balíček veřejný či soukromý.
 * @param {Object} res - Odpověď na požadavek, který přišel na server.
 * @returns {string} successCode
 * @async
 */
exports.updateDeck = (req, res) => {
  // Ověření dat balíčku
  const errorCodes = validateDeckData(req.body.deckName, req.body.deckCards);
  if (errorCodes.length > 0) {
    return res.status(400).json({ errorCodes: errorCodes });
  }

  let deckDocRef = db.collection("decks").doc(req.params.deckId);
  let deletedCards = [];

  // Spuštění databázové transakce
  db.runTransaction(t => {
    return t
      .get(deckDocRef)
      .then(doc => {
        // Ověření, zda-li je upravující uživatel majitelem balíčku
        let creatorId = doc.data().creatorId;
        if (creatorId !== req.user.uid) {
          // Není majitelem, není oprávněn balíček měnit
          return res.status(401).json();
        } else {
          // Vygenerování ID pro každou kartu v balíčku
          let cardArray = [];
          req.body.deckCards.forEach(card => {
            if (!card.cardId) {
              let newCard = card;
              newCard.cardId = newId();
              cardArray.push(newCard);
            } else {
              cardArray.push(card);
            }
          });

          // Vytvoření nových deckData
          let deckData = {
            deckName: req.body.deckName,
            deckDescription: req.body.deckDescription ? req.body.deckDescription : null,
            cardArray: cardArray,
            private: req.body.private
          };

          // Upravení balíčku
          t.update(deckDocRef, deckData);

          // Najde karty, které byly z balíčku odstraněny
          let oldCardArray = doc.data().cardArray;
          let newCardArray = req.body.deckCards;
          deletedCards = findDeletedCards(oldCardArray, newCardArray);

          // Najde všechny soubory, kde je zaznamenán pokrok učení tohoto balíčku
          return db
            .collectionGroup("deckProgress")
            .where("deckId", "==", req.params.deckId)
            .get();
        }
      })
      .then(querySnapshot => {
        // Odstraní pokroky smazaných karet ze souborů s pokroky daných uživatelů
        querySnapshot.forEach(progressDoc => {
          let progressCards = progressDoc.data().cardArray;

          // Odstraní smazané karty z progressCards pole
          deletedCards.forEach(deletedCard => {
            for (let i = 0; i &lt; progressCards.length; i++) {
              // Pokud není karta ještě smazána, zmaže ji
              if (progressCards[i])
                if (progressCards[i].cardId === deletedCard.cardId) {
                  delete progressCards[i];
                }
            }
          });

          // Vytvoří pole nesmazaných karet
          let newProgressCards = [];
          progressCards.forEach(card => {
            // Pokud nebyla karta smazána, vloží ji do newProgressCards pole
            if (typeof card !== undefined) {
              newProgressCards.push(card);
            }
          });

          // Uloží nové pole pokroku karet
          t.update(progressDoc.ref, { cardArray: newProgressCards });
        });
      });
  })
    .then(() => {
      res.status(200).json({ successCode: "updateDeck/deck-updated" });
    })
    .catch(err => {
      console.error(err);
      return res.status(500).json({ errorCode: err.code });
    });
};

// Finds which cards from firstArray are not in the secondArray (=which cards were deleted)
/**
 * @function findDeletedCards
 * @description Porovná dvě pole a najde v prvním poli (firstArray) karty, které byly již v druhém poli (secondArray) smazány.
 * @param {Array&lt;Object>} firstArray - Pole, ve kterém smazané karty stále jsou.
 * @param {Array&lt;Object>} secondArray - Pole, ve kterém smazané karty již nejsou.
 * @returns {Array&lt;Object>} deletedCards - Pole karet, které byly smazány.
 * @async
 */
function findDeletedCards(firstArray, secondArray) {
  let deletedCards = firstArray.filter(function checkInSecondArray(card1) {
    // Search for card1 in the secondArray
    let foundCard = secondArray.find(function isWantedCard(card2) {
      return card1.cardId === card2.cardId;
    });

    return foundCard ? false : true;
  });

  return deletedCards;
}

/**
 * @function deleteDeck
 * @description Odstraní balíček z databáze.
 * @param {Object} req - Požadavek, který přišel na server.
 * @param {string} req.user.uid - ID uživatele
 * @param {string} req.params.deckId - ID balíčku, který má být odstraněn.
 * @returns {string} successCode
 * @async
 */
exports.deleteDeck = (req, res) => {
  let userDocRef = db.collection("users").doc(req.user.uid);
  let deckDocRef = db.collection("decks").doc(req.params.deckId);
  let authorized;

  // Spuštění databázové transakce
  db.runTransaction(t => {
    return t
      .get(deckDocRef)
      .then(doc => {
        // Ověření, zda-li je upravující uživatel majitelem balíčku
        let creatorId = doc.data().creatorId;
        if (creatorId !== req.user.uid) {
          // Není majitelem, není oprávněn balíček smazat
          authorized = false;
          return res.status(401).json();
        } else {
          authorized = true;
          // Odstranění balíčku z databáze
          t.delete(deckDocRef);

          // Odstranění balíčku ze seznamu uživatelem vytvořených balíčků
          t.update(userDocRef, {
            createdDecks: admin.firestore.FieldValue.arrayRemove(req.params.deckId)
          });

          // Získání všech kolekcí, ve kterém se balíček nachází
          return db
            .collection("collections")
            .where("deckArray", "array-contains", req.params.deckId)
            .get();
        }
      })
      .then(querySnapshot => {
        // Odstranění balíčku z každé kolekce
        querySnapshot.forEach(colDoc => {
          t.update(colDoc.ref, {
            deckArray: admin.firestore.FieldValue.arrayRemove(req.params.deckId)
          });
        });

        // Získání všech souborů uživatelů, kteří si balíček připnuli
        return db
          .collection("users")
          .where("pinnedDecks", "array-contains", req.params.deckId)
          .get();
      })
      .then(querySnapshot => {
        // Odstranění všech připnutí daného balíčku
        querySnapshot.forEach(userDoc => {
          t.update(userDoc.ref, {
            pinnedDecks: admin.firestore.FieldValue.arrayRemove(req.params.deckId)
          });
        });

        // Získání všech souborů, ve kterých je zaznamenán pokrok učení balíčku
        return db
          .collectionGroup("deckProgress")
          .where("deckId", "==", req.params.deckId)
          .get();
      })
      .then(querySnapshot => {
        // Smazání všech pokroků učení balíčku
        querySnapshot.forEach(progressDoc => {
          t.delete(progressDoc.ref);
        });
      });
  })
    .then(() => {
      // Odstranění obrázku balíčku
      if (authorized === true) {
        const storage = new Storage();
        const bucket = storage.bucket(config.storageBucket);
        const pngFile = bucket.file(`${req.params.deckId}.png`);
        const jpgFile = bucket.file(`${req.params.deckId}.jpg`);

        // Najde .png obrázek
        pngFile.exists().then(data => {
          const exists = data[0];
          if (exists) {
            // Odstraní .PNG obrázek
            pngFile.delete();
          } else {
            // Najde .jpg obrázek
            jpgFile.exists().then(data => {
              const exists = data[0];
              if (exists) {
                // Odstraní .jpg obrázek
                jpgFile.delete();
              }
            });
          }
        });
      }
    })
    .then(() => {
      res.status(200).json({ successCode: "updateDeck/deck-deleted" });
    })
    .catch(err => {
      console.error(err);
      return res.status(500).json({ errorCode: err.code });
    });
};

/**
 * @function newId
 * @description Vygeneruje nové 20 místné ID
 * @returns {string} newId
 */
function newId() {
  // Alfanumerické znaky
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  let newId = "";
  for (let i = 0; i &lt; 20; i++) {
    newId += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return newId;
}

/**
 * @function uploadDeckImage
 * @description Nahraje obrázek do Cloud Storage.
 * @param {Object} req - Požadavek, který přišel na server.
 * @param {Object} res - Odpověď na požadavek, který přišel na server.
 * @returns {string} successCode
 * @async
 */
// Zdroj: https://youtu.be/ecgAwgHXYos
exports.uploadDeckImage = (req, res) => {
  const BusBoy = require("busboy");
  const path = require("path");
  const os = require("os");
  const fs = require("fs");

  const busboy = new BusBoy({ headers: req.headers });

  let imageToBeUploaded = {};
  let imageFileName;

  busboy.on("file", (fieldname, file, filename, encoding, mimetype) => {
    // Ověření typu nahraného souboru
    if (mimetype !== "image/jpeg" &amp;&amp; mimetype !== "image/png") {
      return res.status(400).json({ error: "Wrong file type submitted" });
    }
    // Vytvoření názvu souboru
    const imageExtension = filename.split(".")[filename.split(".").length - 1];
    imageFileName = `${req.params.deckId}.${imageExtension}`;

    // Připravení souboru na nahrání
    const filepath = path.join(os.tmpdir(), imageFileName);
    imageToBeUploaded = { filepath, mimetype };
    file.pipe(fs.createWriteStream(filepath));
  });
  busboy.on("finish", () => {
    // Nahrání souboru do Cloud Storage
    admin
      .storage()
      .bucket()
      .upload(imageToBeUploaded.filepath, {
        resumable: false,
        metadata: {
          metadata: {
            contentType: imageToBeUploaded.mimetype
          }
        }
      })
      .then(() => {
        // Uložení adresy obrázku do souboru balíčku
        const imageUrl = `https://firebasestorage.googleapis.com/v0/b/${config.storageBucket}/o/${imageFileName}?alt=media`;

        return db.doc(`/decks/${req.params.deckId}`).update({ deckImage: imageUrl });
      })
      .then(() => {
        return res.status(200).json({ successCode: "createDeck/image-uploaded" });
      })
      .catch(err => {
        return res.status(500).json({ errorCode: err.code });
      });
  });
  busboy.end(req.rawBody);
};

//#endregion

//#region Deck Pinning
/**
 * @function pinDeck
 * @description Připne uživateli daný balíček.
 * @param {Object} req - Požadavek, který přišel na server.
 * @param {string} req.user.uid - ID uživatele
 * @param {string} req.params.deckId - ID balíčku, který má být připnut
 * @param {Object} res - Odpověď na požadavek, který přišel na server.
 * @async
 */
exports.pinDeck = (req, res) => {
  if (req.params.deckId) {
    // Přidá balíček do pole připnutých balíčků v souboru uživatele
    db.collection("users")
      .doc(req.user.uid)
      .update({
        pinnedDecks: admin.firestore.FieldValue.arrayUnion(req.params.deckId)
      })
      .then(() => {
        res.status(200).json();
      })
      .catch(error => res.status(500).json({ errorCode: error.code }));
  } else {
    res.status(400).json();
  }
};

/**
 * @function unpinDeck
 * @description Odepne uživateli daný balíček.
 * @param {Object} req - Požadavek, který přišel na server.
 * @param {string} req.user.uid - ID uživatele
 * @param {string} req.params.deckId - ID balíčku, který má být odepnut
 * @param {Object} res - Odpověď na požadavek, který přišel na server.
 * @async
 */
exports.unpinDeck = (req, res) => {
  if (req.params.deckId) {
    // Odebere balíček z pole připnutých balíčků v souboru uživatele
    db.collection("users")
      .doc(req.user.uid)
      .update({
        pinnedDecks: admin.firestore.FieldValue.arrayRemove(req.params.deckId)
      })
      .then(() => {
        res.status(200).json();
      })
      .catch(error => res.status(500).json({ errorCode: error.code }));
  } else {
    res.status(400).json();
  }
};
//#endregion

//#region Deck UI
/**
 * @function getUserDecks
 * @description Získá seznam balíčků vytvořených daným uživatelem.
 * @param {Object} req - Požadavek, který přišel na server.
 * @param {string} req.user.uid - ID uživatele
 * @param {Object} res - Odpověď na požadavek, který přišel na server.
 * @returns {Array&lt;Object>} userDecks - Pole balíčků, které byly vytvořeny uživatelem.
 * @async
 */
exports.getUserDecks = (req, res) => {
  if (req.user.uid) {
    // Získá balíčky, které uživatel vytvořil
    db.collection("decks")
      .where("creatorId", "==", req.user.uid)
      .get()
      .then(querySnapshot => {
        let userDecks = [];

        // Vytvoří pole balíčků
        querySnapshot.forEach(doc => {
          exportDeck = {
            deckName: doc.data().deckName,
            deckImage: doc.data().deckImage,
            deckId: doc.id
          };
          userDecks.push(exportDeck);
        });
        return userDecks;
      })
      .then(userDecks => {
        if (userDecks.length > 0) {
          res.status(200).json(userDecks);
        } else {
          res.status(404).json({ errorCode: "deck/no-deck-found" });
        }
      })
      .catch(error => res.status(500).json({ errorCode: error.code }));
  } else {
    res.status(401).json();
  }
};

/**
 * @function getPinnedDecks
 * @description Získá seznam balíčků připnutých daným uživatelem.
 * @param {Object} req - Požadavek, který přišel na server.
 * @param {string} req.user.uid - ID uživatele
 * @param {Object} res - Odpověď na požadavek, který přišel na server.
 * @returns {Array&lt;Object>} userDecks - Pole balíčků, které byly připnuty uživatelem.
 * @async
 */
exports.getPinnedDecks = (req, res) => {
  if (req.user.uid) {
    let exportDecks = [];

    db.collection("users")
      .doc(req.user.uid)
      .get()
      .then(doc => {
        let pinnedDecks = doc.data().pinnedDecks;
        let promises = [];

        if (pinnedDecks) {
          // Vyhledá informace o každé připnutém balíčku
          pinnedDecks.forEach(deckId => {
            promises.push(
              db
                .collection("decks")
                .doc(deckId)
                .get()
                .then(doc => {
                  // Přidá balíček do exportDecks
                  let exportDeck = {
                    deckName: doc.data().deckName,
                    deckImage: doc.data().deckImage,
                    deckId: doc.id
                  };

                  exportDecks.push(exportDeck);
                })
            );
          });
        }

        // Počká, až se dokončí forEach cyklus
        return Promise.all(promises);
      })
      .then(() => {
        if (exportDecks.length > 0) {
          res.status(200).json(exportDecks);
        } else {
          res.status(404).json({ errorCode: "deck/no-deck-found" });
        }
      })
      .catch(error => res.status(500).json({ errorCode: error.code }));
  } else {
    res.status(401).json();
  }
};

/**
 * @function getDeck
 * @description Získá data daného balíčku.
 * @param {Object} req - Požadavek, který přišel na server.
 * @param {string} req.user.uid - ID uživatele
 * @param {string} req.params.deckId - ID daného balíčku
 * @param {Object} res - Odpověď na požadavek, který přišel na server.
 * @returns {Object} deck - Data o daném balíčku.
 * @async
 */
exports.getDeck = (req, res) => {
  db.collection("decks")
    .doc(`${req.params.deckId}`)
    .get()
    .then(deckDoc => {
      if (deckDoc.exists) {
        let deck = deckDoc.data();

        // Ověření, zda-li je upravující uživatel majitelem balíčku
        let creatorId = deck.creatorId;
        if (deck.private === true &amp;&amp; creatorId !== req.user.uid) {
          // Pokud je balíček soukromý a uživatel není tvůrcem balíčku, nemá přístup k balíčku
          return res.status(403).json();
        } else {
          // Najde uživatelské jméno tvůrce tohoto balíčku
          return db
            .collection("users")
            .doc(deck.creatorId)
            .get()
            .then(userDoc => {
              deck.creatorName = userDoc.data().username;
              return deck;
            });
        }
      } else {
        return res.status(404).json({ errorCode: "deck/deck-not-found" });
      }
    })
    .then(deck => {
      // Zjistí, zda-li je balíček připnut uživatelem.
      return db
        .collection("users")
        .doc(req.user.uid)
        .get()
        .then(userDoc => {
          let pinnedDecks = userDoc.data().pinnedDecks;

          // Zjistí, zda-li je balíček připnut uživatelem.
          let isPinned = false;
          if (pinnedDecks) {
            pinnedDecks.forEach(pinnedDeck => {
              if (pinnedDeck === req.params.deckId) {
                isPinned = true;
              }
            });
          }
          deck.isPinned = isPinned;

          // Zjistí, zda-li je uživatel tvůrcem balíčku.
          let isCreator = deck.creatorId === req.user.uid ? true : false;
          deck.isCreator = isCreator;

          return deck;
        });
    })
    .then(deck => {
      res.status(200).json({ deck });
    })
    .catch(err => {
      console.error(err);
      return res.status(500).json({ errorCode: err.code });
    });
};
//#endregion
</code></pre>
        </article>
    </section>




                </div>
            </div>
        </div>
    </div>


<footer class="footer">
    <div class="content has-text-centered">
        <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Thu Feb 27 2020 14:19:52 GMT+0100 (GMT+01:00)</p>
        <p class="sidebar-created-by">
            <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
            <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
        </p>
    </div>
</footer>


<script src="scripts/app.min.js"></script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
